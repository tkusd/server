box: google/golang

build:
  steps:
    - wercker/setup-go-workspace:
        package-dir: github.com/tkusd/server

    # - wercker/golint

    - script:
        name: install godep
        code: go get github.com/tools/godep

    - script:
        name: godep restore
        code: |
          cd $WERCKER_SOURCE_DIR
          godep restore

    - script:
        name: go env
        code: godep go env

    - script:
        name: go build
        code: |
          godep go build -o tkusd-server

deploy:
  steps:
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DEPLOY_KEY
        overwrite: true
        hide-from-log: true
    - script:
        name: rsync test
        script: |
          rsync
          whereis rsync
    - sjoerdmulder/rsync-deploy:
        host: $DEPLOY_HOST
        sshkey: $PRIVATEKEY_PATH
        user: $DEPLOY_USER
        sshport: $DEPLOY_PORT
        directory: ~/tkusd-server